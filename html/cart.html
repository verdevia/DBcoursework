<!doctype html>
<html>
    <head><meta charset="utf-8"><title>Кошик</title><link rel="stylesheet" href="css/style.css"></head>
    <body>
        <header>
            <div class="menu">
                <div class="container">
                    <div class="bg"></div>
                    <a>Акаунт</a>
                    <div class="dropdown">
                        <a id="login-btn" href="ent.html">Увійти</a> <!-- Кнопка для входу -->
                        <a id="account-btn" href="account.html" style="display:none;">Кабінет</a> <!-- Кнопка для акаунта -->
                        <a id="logout-btn" href="logout" style="display:none;">Вийти</a> <!-- Кнопка для виходу -->
                    </div>
                </div>
                <div class="container">
                    <div class="bg"></div><a href="main.html">На головну</a>
                </div>
                <div class="container">
                    <div class="bg"></div><a href="catalog.html">Каталог</a>
                </div>
                <div class="container">
                    <div class="bg"></div><a href="cart.html" style="text-decoration: underline;">Кошик</a>
                </div>
            </div>
            <div class="darken"></div>
        </header>
        <div class="back">
            <div class="cart-container">
                <h2>Ваш кошик</h2>
                <table class="ctable" id="cart-table">
                    <thead>
                        <tr class="tr">
                            <th>Товар</th>
                            <th>Кількість</th>
                            <th>Ціна</th>
                            <th>Дія</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        <!-- Замовлення буде відображатись тут -->
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            // Перевірка сесії для зміни кнопок у dropdown
            fetch('/session-status')
                   .then(response => response.json())
                   .then(data => {
                       const loginBtn = document.getElementById('login-btn');
                       const accountBtn = document.getElementById('account-btn');
                       const logoutBtn = document.getElementById('logout-btn');

                       if (data.isLoggedIn) {
                           // Якщо користувач увійшов
                           loginBtn.style.display = 'none';
                           accountBtn.style.display = 'block';
                           logoutBtn.style.display = 'block';
                       } else {
                           // Якщо користувач не увійшов
                           loginBtn.style.display = 'block';
                           accountBtn.style.display = 'none';
                           logoutBtn.style.display = 'none';
                       }
                   });
                    // Завантаження замовлення для активного користувача
                fetch('/api/cart')
                    .then(response => response.json())
                    .then(data => {
                        const cartTable = document.getElementById('cart-items');
                        if (data.length === 0) {
                            cartTable.innerHTML = '<tr><td colspan="4">Ваш кошик порожній</td></tr>';
                        } else {
                            data.forEach(item => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price} грн</td>
                                    <td><button onclick="removeItem(${item.product_id}, ${item.quantity})">Видалити</button></td>
                                `;
                                cartTable.appendChild(row);
                            });
                        }
                    })
                    .catch(err => console.error('Помилка при завантаженні кошика:', err));
            
                // Видалення товару з кошика
                function removeItem(productId, currentQuantity) {
                    const quantityToRemove = prompt(`Скільки товару видалити? (Макс: ${currentQuantity})`, currentQuantity);
                    if (quantityToRemove && !isNaN(quantityToRemove) && quantityToRemove > 0 && quantityToRemove <= currentQuantity) {
                        fetch('/api/remove-from-cart', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: productId, quantity: quantityToRemove })
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            location.reload(); // Перезавантажуємо сторінку для оновлення кошика
                        })
                        .catch(err => console.error('Помилка при видаленні товару:', err));
                    } else {
                        alert('Некоректне значення кількості');
                    }
                }
       </script>
    </body>
</html>